<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniTrack Pro | Analytics Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* LIGHT THEME */
            --bg-body: #f0f4f8;
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b;
            --text-sec: #64748b;
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --primary: #4f46e5;
            --primary-grad: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
            --success: #10b981;
            --danger: #ef4444;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --font: 'Outfit', sans-serif;
            --login-bg: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.95);
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --input-bg: #1e293b; 
            --input-border: #475569;
            --primary: #818cf8;
            --primary-grad: linear-gradient(135deg, #6366f1 0%, #a5b4fc 100%);
            --border: #334155;
            --login-bg: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        }

        [data-theme="midnight"] {
            --bg-body: #020617;
            --bg-card: rgba(15, 23, 42, 0.95);
            --text-main: #e2e8f0;
            --text-sec: #64748b;
            --input-bg: #1e293b;
            --input-border: #1e293b;
            --primary: #06b6d4;
            --primary-grad: linear-gradient(135deg, #0891b2 0%, #22d3ee 100%);
            --success: #00ff9d;
            --danger: #ff0055;
            --border: #1e293b;
            --login-bg: linear-gradient(135deg, #000428 0%, #004e92 100%);
        }

        [data-theme="nature"] {
            --bg-body: #f1f8e9;
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-main: #1b5e20;
            --text-sec: #558b2f;
            --input-bg: #ffffff;
            --input-border: #c5e1a5;
            --primary: #2e7d32;
            --primary-grad: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            --success: #2e7d32;
            --danger: #c62828;
            --border: #dcedc8;
            --login-bg: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        body { 
            font-family: var(--font); 
            background: var(--bg-body); 
            color: var(--text-main); 
            display: flex; justify-content: center; 
            min-height: 100vh; padding: 20px; 
        }
        
        .app-container { width: 100%; max-width: 900px; display: none; flex-direction: column; gap: 25px; animation: fadeInApp 0.5s ease-out; }
        @keyframes fadeInApp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* GLASS EFFECT */
        .glass {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: var(--shadow);
            border-radius: 24px;
        }

        /* --- LOGIN SCREEN --- */
        .login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--login-bg);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; 
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .login-card { 
            padding: 50px 40px; text-align: center; width: 90%; max-width: 380px; 
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .login-icon { font-size: 3.5rem; color: #fff; margin-bottom: 15px; }
        .login-title { font-size: 2rem; font-weight: 800; color: #fff; margin-bottom: 5px; }
        .login-subtitle { color: rgba(255,255,255,0.8); margin-bottom: 40px; }

        .pin-container { position: relative; width: 200px; margin: 0 auto 40px auto; }
        .pin-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: default; caret-color: transparent; }
        .dots-display { display: flex; justify-content: space-between; align-items: center; }
        .dot { width: 16px; height: 16px; border-radius: 50%; background-color: rgba(255,255,255,0.3); border: 2px solid rgba(255,255,255,0.5); transition: 0.2s; }
        .dot.active { background-color: #fff; border-color: #fff; transform: scale(1.3); box-shadow: 0 0 15px rgba(255,255,255,0.6); }
        .btn-unlock { width: 100%; padding: 16px; background: #fff; color: #333; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-unlock:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        h1 { font-size: 1.8rem; font-weight: 800; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .sync-badge { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; padding: 8px 16px; border-radius: 50px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-sec); font-weight: 600; }
        .sync-badge.ready i { color: var(--primary); }
        .header-controls { display: flex; gap: 8px; align-items: center; background: var(--bg-card); padding: 5px; border-radius: 50px; border: 1px solid var(--border); }
        .icon-btn { background: transparent; border: none; width: 36px; height: 36px; border-radius: 50%; color: var(--text-sec); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:hover { background: var(--border); color: var(--primary); transform: scale(1.1); }
        .logout-btn:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* --- TABS --- */
        .nav-tabs { display: flex; gap: 5px; background: var(--bg-card); padding: 5px; border-radius: 12px; width: fit-content; margin: 0 auto; border: 1px solid var(--border); }
        .tab-btn { border: none; background: transparent; padding: 10px 25px; border-radius: 8px; cursor: pointer; color: var(--text-sec); font-weight: 600; font-family: var(--font); transition: 0.3s; }
        .tab-btn.active { background: var(--primary-grad); color: white; }
        .view-section { display: none; flex-direction: column; gap: 25px; }
        .view-section.active-view { display: flex; }

        /* --- STATS & FORMS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .card { padding: 25px; text-align: center; }
        .card h3 { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase; font-weight: 600; }
        .card .amount { font-size: 1.5rem; font-weight: 700; }
        .inc { color: var(--success); }
        .exp { color: var(--danger); }
        
        .form-card { padding: 30px; position: relative; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        
        /* === DROPDOWN FIXES === */
        .custom-select-wrapper { 
            position: relative; 
            width: 100%;
        }
        
        .custom-select-wrapper i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none; /* Icon won't block clicks */
            color: var(--text-sec);
            font-size: 0.8rem;
            z-index: 10;
        }

        input, select { 
            width: 100%; 
            padding: 14px 16px; 
            background: var(--input-bg); 
            border: 1px solid var(--input-border); 
            border-radius: 12px; 
            color: var(--text-main); 
            font-size: 1rem; 
            outline: none; 
            font-family: var(--font);
            
            /* Remove Default Arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            
            /* Ensure cursor works */
            cursor: pointer;
        }
        
        /* Add right padding so text doesn't overlap custom icon */
        select { padding-right: 40px; }
        
        /* Fix dropdown options readability in dark mode */
        select option {
            background-color: var(--bg-card);
            color: var(--text-main);
            padding: 10px;
        }

        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        .btn-primary { background: var(--primary-grad); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 600; cursor: pointer; flex: 1; font-family: var(--font); }
        .btn-cancel { background: var(--bg-body); color: var(--text-sec); border: 1px solid var(--border); padding: 16px; border-radius: 12px; font-weight: 600; cursor: pointer; flex: 0.3; display: none; }

        /* --- HISTORY LIST --- */
        .history-section { overflow: hidden; }
        .section-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px 25px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.02); 
        }
        .header-left { display: flex; flex-direction: row; align-items: center; gap: 12px; white-space: nowrap; }
        .header-left h3 { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        
        .count-badge { background: var(--bg-body); color: var(--text-sec); font-size: 0.85rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); }

        .export-btn-small {
            background: var(--success); color: white; border: none;
            padding: 8px 16px; border-radius: 8px; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; font-family: var(--font);
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .export-btn-small:hover { opacity: 0.9; transform: translateY(-1px); }

        .table-responsive { overflow-x: auto; }
        .bank-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 700px; }
        .bank-table th { background: var(--bg-body); text-align: left; padding: 15px 25px; font-size: 0.8rem; color: var(--text-sec); text-transform: uppercase; font-weight: 600; }
        .bank-table td { padding: 18px 25px; border-bottom: 1px solid var(--border); font-size: 0.95rem; vertical-align: middle; }
        .bank-table tr:hover td { background: rgba(0,0,0,0.01); }
        
        .category-badge { display: inline-flex; align-items: center; gap: 8px; font-weight: 600; }
        .pay-mode { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; background: var(--bg-body); color: var(--text-sec); border: 1px solid var(--border); margin-left: 8px; }
        
        .action-icon { cursor: pointer; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; transition: 0.2s; color: var(--text-sec); }
        .action-icon:hover { background: var(--bg-body); color: var(--primary); }
        .action-icon.delete:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        .pagination { display: flex; justify-content: center; gap: 10px; padding: 20px; align-items: center; }
        .page-btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-card); border-radius: 8px; cursor: pointer; color: var(--text-main); font-weight: 600; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ANALYTICS */
        .charts-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; height: 400px; }
        .chart-container { position: relative; height: 100%; padding: 20px; display:flex; align-items:center; justify-content:center; }

        /* --- SETTINGS MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); backdrop-filter: blur(5px); align-items: center; justify-content: center; z-index: 1000; animation: fadeInModal 0.3s; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content { 
            width: 90%; max-width: 500px; padding: 30px;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: center; }
        .modal-header h2 { font-size: 1.5rem; color: var(--text-main); }
        .close-modal { cursor: pointer; font-size: 1.5rem; color: var(--text-sec); transition: 0.2s; }
        .close-modal:hover { color: var(--danger); transform: rotate(90deg); }
        
        .settings-label { display: block; margin-bottom: 8px; font-size: 0.85rem; font-weight: 600; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
        
        .json-btn { 
            width: 100%; padding: 14px; margin-bottom: 12px; 
            border: 1px solid var(--border); border-radius: 12px; 
            background: var(--input-bg); color: var(--text-main); 
            cursor: pointer; text-align: left; display:flex; align-items:center; gap:15px; 
            font-weight: 500; transition:0.2s; 
        }
        .json-btn div { display: flex; flex-direction: column; gap: 4px; }
        .json-btn:hover { background: var(--bg-body); border-color: var(--primary); color: var(--primary); transform: translateX(5px); }
        .json-btn i { color: var(--primary); font-size: 1.2rem; }

        @media (max-width: 768px) { .stats-grid, .form-grid, .charts-wrapper, header { grid-template-columns: 1fr; } header { flex-direction: column; gap: 15px; align-items: flex-start; } .header-right { width: 100%; justify-content: space-between; } .table-responsive { border-radius: 0; } .charts-wrapper { height: auto; } .chart-container { height: 350px; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-overlay">
        <div class="login-card" id="loginCard">
            <div class="login-icon"><i class="fas fa-fingerprint"></i></div>
            <h2 class="login-title">OmniTrack</h2>
            <p class="login-subtitle">Enter PIN to access</p>
            <div class="pin-container">
                <div class="dots-display"><div class="dot" id="dot1"></div><div class="dot" id="dot2"></div><div class="dot" id="dot3"></div><div class="dot" id="dot4"></div></div>
                <input type="number" id="pinInput" class="pin-input" maxlength="4" autocomplete="off" inputmode="numeric">
            </div>
            <button class="btn-unlock" onclick="login()">Unlock</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content glass">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close-modal" onclick="toggleModal(false)">&times;</span>
            </div>
            
            <span class="settings-label">Cloud Sync</span>
            <div class="form-group">
                <input type="text" id="apiUrlInput" placeholder="Paste Google Script URL here..." style="margin-bottom: 12px;">
                <button class="btn-primary" onclick="saveSettings()" style="padding: 12px; font-size: 0.9rem;">Save Configuration</button>
            </div>
            
            <hr style="border:0; border-top:1px solid var(--border); margin: 25px 0;">
            
            <span class="settings-label">Data Management</span>
            <button class="json-btn" onclick="exportJSON()">
                <i class="fas fa-download"></i> 
                <div>
                    <div>Backup Data (JSON)</div>
                    <div style="font-size:0.75rem; color:var(--text-sec); font-weight:400;">Save a local copy of your data</div>
                </div>
            </button>
            <button class="json-btn" onclick="document.getElementById('importFile').click()">
                <i class="fas fa-upload"></i> 
                <div>
                    <div>Restore Data (JSON)</div>
                    <div style="font-size:0.75rem; color:var(--text-sec); font-weight:400;">Restore from a backup file</div>
                </div>
            </button>
            <input type="file" id="importFile" style="display:none" onchange="importJSON(this)">

            <hr style="border:0; border-top:1px solid var(--border); margin: 25px 0;">
            
            <span class="settings-label">Security</span>
            <input type="text" id="newPinInput" placeholder="New 4-digit PIN" maxlength="4">
            <button class="btn-primary" onclick="setNewPin()" style="background:var(--text-sec); margin-top:10px; padding: 12px; font-size: 0.9rem;">Update PIN</button>
            
            <hr style="border:0; border-top:1px solid var(--border); margin: 25px 0;">

            <button onclick="clearAllData()" style="width:100%; padding:14px; background:var(--danger); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600;">
                <i class="fas fa-trash-alt"></i> Reset All Data
            </button>
        </div>
    </div>

    <div class="app-container" id="mainApp">
        <header>
            <h1>OmniTrack <span style="font-size:1rem; color:var(--text-sec); font-weight:400; margin-left:5px;">Pro</span></h1>
            <div class="header-right">
                <div id="syncBadge" class="sync-badge">
                    <i class="fas fa-cloud" id="syncIcon"></i>
                    <span id="syncText">Offline</span>
                </div>
                <div class="header-controls">
                    <button class="icon-btn" onclick="fullSync()" title="Sync Now"><i class="fas fa-sync-alt"></i></button>
                    <button class="icon-btn" onclick="cycleTheme()" title="Change Theme"><i class="fas fa-palette"></i></button>
                    <button class="icon-btn" onclick="toggleModal(true)" title="Settings"><i class="fas fa-cog"></i></button>
                    <button class="icon-btn logout-btn" onclick="logout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i> Dashboard</button>
            <button class="tab-btn" onclick="switchTab('analytics')"><i class="fas fa-chart-pie"></i> Analytics</button>
        </div>

        <div id="dashboardView" class="view-section active-view">
            <div class="stats-grid">
                <div class="card glass"><h3>Total Balance</h3><div class="amount" id="balanceDisplay">‚Çπ0.00</div></div>
                <div class="card glass"><h3>Total Income</h3><div class="amount inc" id="incomeDisplay">+‚Çπ0.00</div></div>
                <div class="card glass"><h3>Total Expense</h3><div class="amount exp" id="expenseDisplay">-‚Çπ0.00</div></div>
            </div>

            <div class="form-card glass">
                <h3 style="margin-bottom:20px; font-weight:700;" id="formTitle">New Transaction</h3>
                <form id="expenseForm">
                    <div class="form-grid">
                        <div class="full-width"><input type="text" id="desc" placeholder="What is this for?" required></div>
                        <div><input type="number" id="amount" placeholder="Amount (‚Çπ)" step="0.01" required></div>
                        
                        <div class="custom-select-wrapper">
                            <select id="type">
                                <option value="expense">Expense (-)</option>
                                <option value="income">Income (+)</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>

                        <div class="custom-select-wrapper">
                            <select id="category">
                                <option value="food">üçî Food & Dining</option>
                                <option value="grocery">ü•¶ Grocery</option>
                                <option value="transport">üöó Transport</option>
                                <option value="utilities">üí° Utilities</option>
                                <option value="entertainment">üé¨ Entertainment</option>
                                <option value="salary">üí∞ Salary</option>
                                <option value="shopping">üõçÔ∏è Shopping</option>
                                <option value="health">üíä Health</option>
                                <option value="other">üì¶ Other</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>

                        <div class="custom-select-wrapper">
                            <select id="payMode">
                                <option value="online">üí≥ Online / UPI</option>
                                <option value="cash">üíµ Cash</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>

                        <div><input type="datetime-local" id="dateInput" required></div>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn-primary" id="submitBtn"><i class="fas fa-plus"></i> Add Transaction</button>
                        <button type="button" class="btn-cancel" id="cancelBtn" onclick="cancelEdit()">Cancel</button>
                    </div>
                </form>
            </div>

            <div class="history-section glass">
                <div class="section-header">
                    <div class="header-left">
                        <h3>Transactions</h3>
                        <span id="txCount" class="count-badge">0</span>
                    </div>
                    <button class="export-btn-small" onclick="exportBankStatement()">
                        <i class="fas fa-file-csv fa-lg"></i> Export CSV
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="bank-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th style="text-align:right">Debit</th>
                                <th style="text-align:right">Credit</th>
                                <th style="text-align:right">Balance</th>
                                <th style="text-align:center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="list"></tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button class="page-btn" onclick="changePage(-1)" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
                    <span id="pageIndicator" style="font-size: 0.9rem; font-weight:600; color:var(--text-sec);">Page 1</span>
                    <button class="page-btn" onclick="changePage(1)" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <div id="analyticsView" class="view-section">
            <div class="charts-wrapper">
                <div class="chart-container glass"><canvas id="categoryChart"></canvas></div>
                <div class="chart-container glass"><canvas id="flowChart"></canvas></div>
            </div>
        </div>
    </div>

<script>
    // --- STATE ---
    let appState = {
        pin: localStorage.getItem('userPin') || '1234',
        transactions: JSON.parse(localStorage.getItem('transactions')) || []
    };
    let apiUrl = localStorage.getItem('apiUrl') || '';
    const themes = ['light', 'dark', 'midnight', 'nature'];
    let currentThemeIndex = themes.indexOf(localStorage.getItem('theme') || 'light');
    if (currentThemeIndex === -1) currentThemeIndex = 0;
    let currentPage = 1;
    const itemsPerPage = 5;
    let processedTransactions = [];
    let editingId = null;
    let catChart = null, flowChart = null;

    // --- DOM ---
    const mainApp = document.getElementById('mainApp');
    const loginScreen = document.getElementById('loginScreen');
    const loginCard = document.getElementById('loginCard');
    const pinInput = document.getElementById('pinInput');
    
    // --- INIT ---
    initialize();

    function initialize() {
        resetFormDate();
        document.getElementById('apiUrlInput').value = apiUrl;
        applyTheme();
        updateSyncStatus();
        if(sessionStorage.getItem('isLoggedIn') !== 'true') pinInput.focus();
        else showApp();
    }

    // --- THEME ---
    function cycleTheme() {
        currentThemeIndex = (currentThemeIndex + 1) % themes.length;
        localStorage.setItem('theme', themes[currentThemeIndex]);
        applyTheme();
    }
    function applyTheme() {
        document.documentElement.setAttribute('data-theme', themes[currentThemeIndex]);
        if(document.getElementById('analyticsView').style.display === 'flex') renderCharts();
    }

    // --- LOGIN ---
    pinInput.addEventListener('input', function() {
        const val = this.value, len = val.length;
        for(let i=1; i<=4; i++) {
            const dot = document.getElementById('dot'+i);
            if(i <= len) dot.classList.add('active'); else dot.classList.remove('active');
        }
        if(len === 4) setTimeout(() => login(), 100);
    });

    function login() {
        if(pinInput.value === appState.pin) {
            sessionStorage.setItem('isLoggedIn', 'true');
            showApp();
            pinInput.value = '';
            for(let i=1; i<=4; i++) document.getElementById('dot'+i).classList.remove('active');
        } else {
            loginCard.classList.add('shake');
            setTimeout(() => { loginCard.classList.remove('shake'); pinInput.value = ''; for(let i=1; i<=4; i++) document.getElementById('dot'+i).classList.remove('active'); pinInput.focus(); }, 500);
        }
    }

    function logout() {
        sessionStorage.removeItem('isLoggedIn');
        mainApp.style.display = 'none';
        loginScreen.style.display = 'flex';
        pinInput.focus();
    }

    function showApp() {
        loginScreen.style.display = 'none';
        mainApp.style.display = 'flex';
        processData();
    }

    // --- CORE ---
    function processData() {
        const sorted = [...appState.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
        let runningBalance = 0;
        processedTransactions = sorted.map(t => {
            if(t.type === 'income') runningBalance += t.amount;
            else runningBalance -= t.amount;
            return { ...t, balanceAfter: runningBalance };
        });
        processedTransactions.reverse();
        updateUI();
    }

    function updateUI() {
        const amts = appState.transactions.map(t => t.type === 'income' ? t.amount : -t.amount);
        const total = amts.reduce((acc, i) => acc + i, 0).toFixed(2);
        const inc = amts.filter(i => i > 0).reduce((acc, i) => acc + i, 0).toFixed(2);
        const exp = (amts.filter(i => i < 0).reduce((acc, i) => acc + i, 0) * -1).toFixed(2);

        document.getElementById('balanceDisplay').innerText = `‚Çπ${formatMoney(total)}`;
        document.getElementById('incomeDisplay').innerText = `+‚Çπ${formatMoney(inc)}`;
        document.getElementById('expenseDisplay').innerText = `-‚Çπ${formatMoney(exp)}`;
        document.getElementById('txCount').innerText = `${appState.transactions.length}`;

        renderTable();
        if(document.getElementById('analyticsView').style.display === 'flex') renderCharts();
    }

    function renderTable() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        const start = (currentPage - 1) * itemsPerPage;
        const pageItems = processedTransactions.slice(start, start + itemsPerPage);
        
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = start + itemsPerPage >= processedTransactions.length;
        document.getElementById('pageIndicator').innerText = `Page ${currentPage}`;

        if(pageItems.length === 0) list.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:var(--text-sec);">No transactions found.</td></tr>';

        pageItems.forEach(t => {
            const tr = document.createElement('tr');
            const d = new Date(t.date);
            const modeText = t.payMode === 'online' ? 'Online' : 'Cash';
            tr.innerHTML = `
                <td style="color:var(--text-sec); font-size:0.85rem;">${d.toLocaleDateString()}<br><small>${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</small></td>
                <td>
                    <div class="category-badge">
                        ${getCategoryIcon(t.category)} <span>${t.desc}</span> 
                        <span class="pay-mode">${modeText}</span>
                    </div>
                </td>
                <td style="text-align:right; color:var(--danger); font-weight:500;">${t.type==='expense' ? '‚Çπ'+formatMoney(t.amount) : '-'}</td>
                <td style="text-align:right; color:var(--success); font-weight:500;">${t.type==='income' ? '‚Çπ'+formatMoney(t.amount) : '-'}</td>
                <td style="text-align:right; font-weight:700;">‚Çπ${formatMoney(t.balanceAfter.toFixed(2))}</td>
                <td style="text-align:center;">
                    <i class="fas fa-pen action-icon" onclick="editTx(${t.id})"></i>
                    <i class="fas fa-trash-alt action-icon delete" onclick="deleteTx(${t.id})"></i>
                </td>
            `;
            list.appendChild(tr);
        });
    }

    // --- FORM ---
    document.getElementById('expenseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const payload = {
            id: editingId || generateID(),
            desc: document.getElementById('desc').value,
            amount: parseFloat(document.getElementById('amount').value),
            type: document.getElementById('type').value,
            category: document.getElementById('category').value,
            payMode: document.getElementById('payMode').value,
            date: document.getElementById('dateInput').value,
            synced: false
        };

        if(editingId) {
            const idx = appState.transactions.findIndex(t => t.id === editingId);
            appState.transactions[idx] = payload;
            cancelEdit();
        } else {
            appState.transactions.push(payload);
            this.reset();
            resetFormDate();
        }
        
        saveState();
        processData();
        if(apiUrl) fullSync(); 
    });

    async function fullSync() {
        if(!apiUrl) { alert("Configure URL in Settings."); return; }
        updateSyncStatus('syncing');
        try {
            await fetch(apiUrl, { method: 'POST', body: JSON.stringify(appState) });
            updateSyncStatus('success');
        } catch(e) { updateSyncStatus('ready'); }
    }

    function renderCharts() {
        if(catChart) catChart.destroy();
        if(flowChart) flowChart.destroy();

        const cats = {};
        let inc = 0, exp = 0;
        appState.transactions.forEach(t => {
            if(t.type === 'expense') { cats[t.category] = (cats[t.category] || 0) + t.amount; exp += t.amount; }
            else inc += t.amount;
        });

        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-main').trim();
        const ctx1 = document.getElementById('categoryChart').getContext('2d');
        const ctx2 = document.getElementById('flowChart').getContext('2d');

        catChart = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(cats),
                datasets: [{ data: Object.values(cats), backgroundColor: ['#ff7675', '#74b9ff', '#ffeaa7', '#55efc4', '#a29bfe', '#fab1a0'], borderWidth: 0 }]
            },
            options: { 
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: textColor } }, title: { display: true, text: 'Expense Categories', color: textColor } } 
            }
        });

        flowChart = new Chart(ctx2, {
            type: 'bar',
            data: { labels: ['Income', 'Expense'], datasets: [{ label: 'Amount (‚Çπ)', data: [inc, exp], backgroundColor: ['#10b981', '#ef4444'], borderRadius: 8 }] },
            options: { 
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: 'Income vs Expense', color: textColor } }, 
                scales: { y: { ticks: { color: textColor } }, x: { ticks: { color: textColor } } } 
            }
        });
    }

    // --- HELPERS ---
    function editTx(id) {
        const t = appState.transactions.find(x => x.id === id);
        if(!t) return;
        editingId = id;
        document.getElementById('desc').value = t.desc;
        document.getElementById('amount').value = t.amount;
        document.getElementById('type').value = t.type;
        document.getElementById('category').value = t.category;
        document.getElementById('payMode').value = t.payMode || 'online';
        const d = new Date(t.date); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
        document.getElementById('dateInput').value = d.toISOString().slice(0,16);
        document.getElementById('submitBtn').innerHTML = "<i class='fas fa-save'></i> Update Transaction";
        document.getElementById('cancelBtn').style.display = "block";
        document.getElementById('formTitle').innerText = "Edit Transaction";
        document.querySelector('.form-card').scrollIntoView({behavior:'smooth'});
    }

    function cancelEdit() {
        editingId = null;
        document.getElementById('expenseForm').reset();
        resetFormDate();
        document.getElementById('submitBtn').innerHTML = "<i class='fas fa-plus'></i> Add Transaction";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('formTitle').innerText = "New Transaction";
    }

    function deleteTx(id) {
        if(confirm("Delete this transaction?")) {
            appState.transactions = appState.transactions.filter(t => t.id !== id);
            saveState(); processData(); fullSync();
        }
    }

    function saveState() {
        localStorage.setItem('transactions', JSON.stringify(appState.transactions));
        localStorage.setItem('userPin', appState.pin);
    }
    
    function resetFormDate() {
        const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('dateInput').value = now.toISOString().slice(0,16);
    }
    
    function changePage(dir) { currentPage += dir; renderTable(); }
    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));
        if(t==='dashboard'){ document.querySelector('[onclick="switchTab(\'dashboard\')"]').classList.add('active'); document.getElementById('dashboardView').classList.add('active-view'); }
        else { document.querySelector('[onclick="switchTab(\'analytics\')"]').classList.add('active'); document.getElementById('analyticsView').classList.add('active-view'); renderCharts(); }
    }

    function setNewPin() {
        const p = document.getElementById('newPinInput').value;
        if(p.length===4 && !isNaN(p)) { appState.pin = p; saveState(); alert("PIN Updated"); fullSync(); } 
        else alert("Must be 4 digits");
    }

    function updateSyncStatus(s='idle') {
        const b=document.getElementById('syncBadge'), t=document.getElementById('syncText'), i=document.getElementById('syncIcon');
        b.className='sync-badge';
        if(!apiUrl) { b.classList.add('offline'); t.innerText="Offline"; i.className="fas fa-cloud"; }
        else if(s==='syncing') { b.classList.add('syncing'); t.innerText="Syncing..."; i.className="fas fa-sync fa-spin"; }
        else if(s==='success') { b.classList.add('success'); t.innerText="Synced"; i.className="fas fa-check"; setTimeout(()=>updateSyncStatus('ready'),3000); }
        else { b.classList.add('ready'); t.innerText="Ready"; i.className="fas fa-cloud"; }
    }
    
    function exportBankStatement() {
        if(appState.transactions.length===0) { alert("No data"); return; }
        const sorted = [...processedTransactions].reverse();
        let csv = "Date,Time,Description,Category,PayMode,Debit,Credit,Balance\n";
        sorted.forEach(t => {
            const d = new Date(t.date);
            const inc = t.type==='income';
            csv += `${d.toLocaleDateString()},${d.toLocaleTimeString()},"${t.desc}",${t.category},${t.payMode},${!inc?t.amount:""},${inc?t.amount:""},${t.balanceAfter.toFixed(2)}\n`;
        });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'Statement.csv'; a.click();
    }
    
    function exportJSON() {
        const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState.transactions));
        const a = document.createElement('a'); a.href=d; a.download="backup.json"; a.click();
    }
    function importJSON(i) {
        const f=i.files[0]; if(!f)return;
        const r=new FileReader();
        r.onload=e=>{
            try {
                const data = JSON.parse(e.target.result);
                if(Array.isArray(data)) { appState.transactions = [...appState.transactions, ...data]; saveState(); processData(); alert("Imported!"); toggleModal(false); }
                else alert("Invalid JSON");
            } catch(err) { alert("Error reading file"); }
        };
        r.readAsText(f);
    }
    
    function toggleModal(s) { document.getElementById('settingsModal').style.display = s?'flex':'none'; }
    function saveSettings() { const u = document.getElementById('apiUrlInput').value.trim(); if(u){ localStorage.setItem('apiUrl',u); apiUrl=u; updateSyncStatus('ready'); alert("Saved"); toggleModal(false); } }
    function clearAllData() { if(confirm("Reset everything?")) { appState.transactions=[]; saveState(); processData(); fullSync(); toggleModal(false); } }
    function formatMoney(x) { return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function generateID() { return Math.floor(Math.random()*100000000); }
    function getCategoryIcon(c) { const m={'food':'üçî','transport':'üöó','utilities':'üí°','entertainment':'üé¨','salary':'üí∞','shopping':'üõçÔ∏è','health':'üíä','grocery':'ü•¶','other':'üì¶'}; return m[c]||'üì¶'; }
</script>
</body>
</html>
